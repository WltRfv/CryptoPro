{% extends "base.html" %}

{% block content %}
<div class="nav">
    <div>
        <h1>üöÄ CryptoPro –ö–æ—à–µ–ª–µ–∫</h1>
        <p class="welcome-text">
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ—à–µ–ª–µ–∫, CryptoPro! üåü
            {% if current_user.is_authenticated %}
                <br><small>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: {{ current_user.name }}</small>
            {% endif %}
        </p>
    </div>
    <div class="nav-links">
        {% if not current_user.is_authenticated %}
            <a href="{{ url_for('frontend.personal_login') }}" class="btn btn-success">üë§ –í—Ö–æ–¥</a>
        {% else %}
            <span style="color: #2c3e50; font-weight: 600;">{{ current_user.name }}</span>
            <a href="{{ url_for('frontend.logout') }}" class="btn btn-danger">üö™ –í—ã–π—Ç–∏</a>
        {% endif %}
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã -->
<div class="stats-grid">
    <!-- –ö–æ–º–∞–Ω–¥–∞ CryptoPro -->
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h3 style="color: white;">üë• –ö–æ–º–∞–Ω–¥–∞ CryptoPro</h3>
        <div style="margin-top: 20px;">
            {% for member in members %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.2);">
                <span style="font-weight: 600;">{{ member.name }}</span>
                <span style="font-weight: 700; color: #a8e6cf;">{{ member.points }} –±–∞–ª–ª–æ–≤</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –û–±—â–∏–µ –±–∞–ª–ª—ã –∫–æ–º–∞–Ω–¥—ã -->
    <div class="stat-card">
        <h3>üèÜ –û–±—â–∏–µ –±–∞–ª–ª—ã</h3>
        <div class="stat-number">{{ team.total_points }}</div>
        <p>–í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤ —É –∫–æ–º–∞–Ω–¥—ã</p>
    </div>

    <!-- –õ–∏—á–Ω—ã–µ –±–∞–ª–ª—ã -->
    <div class="stat-card">
        <h3>üíº –õ–∏—á–Ω—ã–µ –±–∞–ª–ª—ã</h3>
        <div class="stat-number">
            {% if current_user.is_authenticated %}
                {{ current_user.points }}
            {% else %}
                -
            {% endif %}
        </div>
        <p>–í–∞—à–∏ –ª–∏—á–Ω—ã–µ –±–∞–ª–ª—ã</p>
    </div>
</div>

{% if current_user.is_authenticated %}
<!-- –¢–æ–ª—å–∫–æ –¥–ª—è –≤–æ—à–µ–¥—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
    <!-- –ü–µ—Ä–µ–≤–æ–¥ –±–∞–ª–ª–æ–≤ -->
    <div class="card">
        <h2>üîÑ –ü–µ—Ä–µ–≤–æ–¥ –±–∞–ª–ª–æ–≤</h2>
        <form method="POST" action="{{ url_for('frontend.transfer_points') }}">
            <div class="form-group">
                <label for="to_member_id">–ö–æ–º—É –ø–µ—Ä–µ–≤–µ—Å—Ç–∏:</label>
                <select id="to_member_id" name="to_member_id" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</option>
                    {% for member in members %}
                        {% if member.id != current_user.id %}
                        <option value="{{ member.id }}">{{ member.name }} ({{ member.points }} –±–∞–ª–ª–æ–≤)</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="amount">–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:</label>
                <input type="number" id="amount" name="amount" min="1" max="{{ current_user.points }}"
                       placeholder="–ú–∞–∫—Å–∏–º—É–º: {{ current_user.points }}" required>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;">
                üí´ –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥
            </button>
        </form>
    </div>

    <!-- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–æ–ø—Ä–æ—Å -->
    <div class="card">
        <h2>üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</h2>
        <form method="POST" action="{{ url_for('frontend.propose_question') }}">
            <div class="form-group">
                <label for="content">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                <textarea id="content" name="content" rows="3" required
                         placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..."></textarea>
            </div>

            <div class="form-group">
                <label for="price">–¶–µ–Ω–∞ –≤–æ–ø—Ä–æ—Å–∞ (–±–∞–ª–ª—ã):</label>
                <input type="number" id="price" name="price" min="10" required>
            </div>

            <button type="submit" class="btn btn-success" style="width: 100%;">
                üåü –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–æ–ø—Ä–æ—Å
            </button>
        </form>
    </div>
</div>

<!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
<div class="card">
    <h2>üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
        {% for question in available_questions %}
        <div class="card" style="background: linear-gradient(135deg, #f8fbff 0%, #f0f7ff 100%);">
            <h4 style="color: #2c3e50; margin-bottom: 15px;">{{ question.content }}</h4>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <span style="font-weight: bold; color: #667eea; font-size: 1.2em;">
                    {{ question.price }} –±–∞–ª–ª–æ–≤
                </span>

                <!-- –ü–†–û–í–ï–†–Ø–ï–ú –ö–£–ü–õ–ï–ù –õ–ò –í–û–ü–†–û–° –ö–û–ú–ê–ù–î–û–ô -->
                {% set question_purchased = false %}
                {% for purchase in purchased_questions %}
                    {% if purchase.question.id == question.id %}
                        {% set question_purchased = true %}
                    {% endif %}
                {% endfor %}

                {% if question_purchased %}
                    <!-- –í–û–ü–†–û–° –£–ñ–ï –ö–£–ü–õ–ï–ù –ö–û–ú–ê–ù–î–û–ô - –°–ï–†–ê–Ø –ö–ù–û–ü–ö–ê -->
                    <button type="button" class="btn" style="background: #95a5a6; color: white; cursor: not-allowed; border: none; padding: 12px 20px; border-radius: 10px; font-weight: 600;" disabled>
                        ‚úÖ –í–æ–ø—Ä–æ—Å –∫—É–ø–ª–µ–Ω
                    </button>
                {% else %}
                    <!-- –í–û–ü–†–û–° –ï–©–ï –ù–ï –ö–£–ü–õ–ï–ù - –ó–ï–õ–ï–ù–ê–Ø –ö–ù–û–ü–ö–ê -->
                    <form method="POST" action="{{ url_for('frontend.purchase_question') }}" style="margin: 0;">
                        <input type="hidden" name="question_id" value="{{ question.id }}">
                        <button type="submit" class="btn btn-primary"
                                {% if current_user.points < question.price %}disabled{% endif %}>
                            üõí –ö—É–ø–∏—Ç—å –≤–æ–ø—Ä–æ—Å
                        </button>
                    </form>
                {% endif %}
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –±–∞–ª–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –µ—â–µ –Ω–µ –∫—É–ø–ª–µ–Ω) -->
            {% if not question_purchased and current_user.points < question.price %}
            <p style="color: #ff6b6b; font-size: 0.9em; margin-top: 10px; font-weight: 600;">
                ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ (–Ω—É–∂–Ω–æ: {{ question.price }})
            </p>
            {% endif %}

            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, –∫—Ç–æ –∫—É–ø–∏–ª –≤–æ–ø—Ä–æ—Å -->
            {% if question_purchased %}
                {% for purchase in purchased_questions %}
                    {% if purchase.question.id == question.id %}
                    <p style="color: #4ecdc4; font-size: 0.9em; margin-top: 10px; font-weight: 600;">
                        ‚úÖ –ö—É–ø–∏–ª: {{ purchase.purchaser.name }}
                    </p>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö -->
<div class="card info-box" style="text-align: center;">
    <h2>üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –ª–∏—á–Ω—ã–π –≤—Ö–æ–¥</h2>
    <p style="margin-bottom: 20px; font-weight: 600;">–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π (–ø–µ—Ä–µ–≤–æ–¥—ã, –ø–æ–∫—É–ø–∫–∏) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</p>
    <a href="{{ url_for('frontend.personal_login') }}" class="btn btn-success" style="font-size: 1.1em;">
        üë§ –í–æ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
    </a>
</div>
{% endif %}

<!-- –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 30px;">
    <!-- –ö—É–ø–ª–µ–Ω–Ω—ã–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
    <div class="card">
        <h2>üíº –ö—É–ø–ª–µ–Ω–Ω—ã–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h2>

        <!-- –ö—É–ø–ª–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
        <h3 style="color: #4ecdc4; margin: 20px 0 15px 0;">üõí –ö—É–ø–ª–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
        {% if purchased_questions %}
            <div style="max-height: 200px; overflow-y: auto; margin-bottom: 25px;">
                {% for purchase in purchased_questions %}
                <div class="member-item">
                    <div>
                        <strong style="color: #2c3e50;">{{ purchase.question.content }}</strong>
                        <div style="color: #667eea; font-size: 0.9em; font-weight: 600;">
                            –ö—É–ø–∏–ª: {{ purchase.purchaser.name }} ‚Ä¢ {{ purchase.purchase.purchased_at.strftime('%d.%m.%Y') }}
                        </div>
                    </div>
                    <div style="color: #ff6b6b; font-weight: bold;">
                        -{{ purchase.question.price }}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 20px; color: #667eea; margin-bottom: 25px;">
                <p>üìù –ü–æ–∫–∞ –Ω–µ –∫—É–ø–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞</p>
            </div>
        {% endif %}

        <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
        <h3 style="color: #a8e6cf; margin: 20px 0 15px 0;">üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
        {% if proposed_questions %}
            <div style="max-height: 200px; overflow-y: auto;">
                {% for question in proposed_questions %}
                <div class="member-item">
                    <div>
                        <strong style="color: #2c3e50;">{{ question.content }}</strong>
                        <div style="color: #56ab91; font-size: 0.9em; font-weight: 600;">
                            {{ question.created_at.strftime('%d.%m.%Y') }} ‚Ä¢ {{ question.price }} –±–∞–ª–ª–æ–≤
                        </div>
                    </div>
                    <div style="color: #56ab91; font-weight: bold; font-size: 0.9em;">
                        {% if question.is_approved %}
                            ‚úÖ –û–¥–æ–±—Ä–µ–Ω
                        {% else %}
                            ‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 20px; color: #56ab91;">
                <p>üí° –ü–æ–∫–∞ –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞</p>
            </div>
        {% endif %}
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ -->
    <div class="card">
        <h2>üìä –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤</h2>
        {% if transfers %}
            <div style="max-height: 400px; overflow-y: auto;">
                {% for transfer_data in transfers %}
                <div class="member-item">
                    <div>
                        <strong style="color: #2c3e50;">{{ transfer_data.from_member.name }} ‚Üí {{ transfer_data.to_member.name }}</strong>
                        <div style="color: #667eea; font-size: 0.9em; font-weight: 600;">
                            {{ transfer_data.transfer.transferred_at.strftime('%d.%m.%Y %H:%M') }}
                        </div>
                    </div>
                    <div style="font-weight: bold; color: #a8e6cf;">
                        +{{ transfer_data.transfer.amount }} –±–∞–ª–ª–æ–≤
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 40px; color: #667eea;">
                <p>üí´ –ü–æ–∫–∞ –Ω–µ –±—ã–ª–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
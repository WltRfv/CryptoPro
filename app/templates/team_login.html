<!-- templates/team_login.html - –ó–ê–ú–ï–ù–ò –≤–µ—Å—å —Ñ–∞–π–ª –Ω–∞ –≠–¢–£ –≤–µ—Ä—Å–∏—é -->
{% extends "base.html" %}

{% block content %}
<div style="max-width: 800px; margin: 40px auto;">
    <div class="card" style="text-align: center;">
        <div style="margin-bottom: 30px;">
            <h1>üöÄ CryptoPro –ö–æ—à–µ–ª–µ–∫</h1>
            <p style="color: #667eea; font-size: 1.1em; font-weight: 600;">–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏ RSA</p>
        </div>

        <form method="POST">
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                üîê –ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            </button>
        </form>

        {% if session_token and challenge_message %}
        <div class="info-box" style="margin-top: 25px; text-align: left;">
            <h3 style="color: #1a535c; margin-bottom: 15px;">‚úÖ –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞!</h3>

            <div class="form-group">
                <label>–¢–æ–∫–µ–Ω —Å–µ—Å—Å–∏–∏:</label>
                <input type="text" value="{{ session_token }}" readonly
                       style="background: #f8f9fa; font-family: 'Courier New', monospace;">
            </div>

            <div class="form-group">
                <label>Challenge-—Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏:</label>
                <textarea readonly rows="3" style="background: #f8f9fa; font-family: 'Courier New', monospace;"
                         id="challengeMessage">{{ challenge_message }}</textarea>
            </div>

            <button class="btn btn-success" onclick="copyChallenge()" style="width: 100%;">
                üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å challenge
            </button>
        </div>
        {% endif %}
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –ø–æ–¥–ø–∏—Å–∏ -->
    <div class="card">
        <h2>‚úçÔ∏è –í–≤–æ–¥ —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∏</h2>
        <form id="verifyForm">
            <div class="form-group">
                <label for="member_name">–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞:</label>
                <select id="member_name" name="member_name" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</option>
                    <option value="–°–∞–º–æ–Ω–æ–≤">–°–∞–º–æ–Ω–æ–≤</option>
                    <option value="–ì–∞–ª–∫–∏–Ω–∞">–ì–∞–ª–∫–∏–Ω–∞</option>
                    <option value="–ú–æ—Ü–∏–ø–∞–Ω">–ú–æ—Ü–∏–ø–∞–Ω</option>
                    <option value="–ò—Å–º–∞–π–ª–æ–≤">–ò—Å–º–∞–π–ª–æ–≤</option>
                </select>
            </div>

            <div class="form-group">
                <label for="signature">–¶–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å:</label>
                <textarea id="signature" name="signature" rows="4"
                         placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à—É —Ü–∏—Ñ—Ä–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å..."
                         required></textarea>
            </div>

            {% if session_token %}
            <input type="hidden" id="session_token" name="session_token" value="{{ session_token }}">
            {% endif %}

            <button type="submit" class="btn btn-success" style="width: 100%;">
                üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å
            </button>
        </form>

        <div id="result" style="margin-top: 20px;"></div>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="card info-box">
        <h3>üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
        <ol style="text-align: left; margin: 15px 0; padding-left: 20px;">
            <li><strong>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"</strong> - —Å–æ–∑–¥–∞—Å—Ç—Å—è —Å–µ—Å—Å–∏—è —Å challenge-—Å–æ–æ–±—â–µ–Ω–∏–µ–º</li>
            <li><strong>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ challenge-—Å–æ–æ–±—â–µ–Ω–∏–µ</strong> –∏ –ø–æ–¥–ø–∏—à–∏—Ç–µ –µ–≥–æ —Å–≤–æ–∏–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–ª—é—á–æ–º</li>
            <li><strong>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ –∏–º—è</strong> –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—É—é –ø–æ–¥–ø–∏—Å—å –≤ —Ñ–æ—Ä–º—É</li>
            <li><strong>–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å"</strong> - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à—É —Ü–∏—Ñ—Ä–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å</li>
        </ol>

        <div style="background: #fffbeb; padding: 15px; border-radius: 10px; margin-top: 15px;">
            <h4 style="color: #d97706;">üîß –ù—É–∂–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏?</h4>
            <p>–°–∫–∞—á–∞–π—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —É—Ç–∏–ª–∏—Ç—É –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ RSA –∫–ª—é—á–∞–º–∏.</p>
            <a href="/signing-tool" class="btn" style="background: #f59e0b; color: white; margin-top: 10px;">
                üõ†Ô∏è –û—Ç–∫—Ä—ã—Ç—å —É—Ç–∏–ª–∏—Ç—É –ø–æ–¥–ø–∏—Å–∏
            </a>
        </div>
    </div>
</div>

<script>
function copyChallenge() {
    const challengeText = document.getElementById('challengeMessage');
    challengeText.select();
    document.execCommand('copy');
    alert('‚úÖ Challenge —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
}

document.getElementById('verifyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const button = this.querySelector('button');
    const resultDiv = document.getElementById('result');

    button.disabled = true;
    button.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å...';
    resultDiv.innerHTML = '<div class="alert alert-info">üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–∏—Ñ—Ä–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å...</div>';

    fetch('/verify-signature', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
            button.textContent = '‚úÖ –ü–æ–¥–ø–∏—Å—å –≤–µ—Ä–Ω–∞!';

            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (data.redirect_url) {
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 2000);
            }
        } else {
            resultDiv.innerHTML = '<div class="alert alert-error">' + data.message + '</div>';
            button.disabled = false;
            button.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å';
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error + '</div>';
        button.disabled = false;
        button.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å';
    });
});
</script>
{% endblock %}